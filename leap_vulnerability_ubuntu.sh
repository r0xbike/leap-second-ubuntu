#!/bin/bash
# leap_vulnerability_ubuntu.sh
# Version 0.1 for Ubuntu
# 1 June 2015
#
# This script is heavily based on RedHat's Leap Second Issue Detector script. 
# <https://access.redhat.com/labs/leapsecond/> RedHat's script only works on RedHat/CentOS.
# This script works only on Ubuntu and checks for Ubuntu-specific vulnerabilities and resolutions.
#
# For each Ubuntu LTS version 10.10/12.10/14.10 there are appropriate tzdata packages
# that should be installed.
# minimum:
# 10.10: 2015a-0ubuntu0.10.04
# 12.10: 2015a-0ubuntu0.12.04
# 14.10: 2015a-0ubuntu0.14.04
#
# latest:
# 10.10: 2015d-0ubuntu0.10.04
# 12.10: 2015d-0ubuntu0.12.04
# 14.10: 2015d-0ubuntu0.14.04
#
# Since the correct version is the same for all major releases, check that the 
# installed tzdata package is from 2015 (as the 2015a is the first tzdata release of 2015)
#
# If there are outdated tzdata packages, check to see if the localtime file indicates
# that the tzdata package needs to be or may need to be updated for the Leap Second.
#
# Check for the proper kernel versions as well - The linux kernel was patched in version 3.4
# to remove a bug that caused livelocks in the timer subsystem when the leap second was inserted.
# Kernel versions 3.4 and higher arenâ€™t affected by the bug.
# https://github.com/torvalds/linux/commit/6b43ae8a619d17c4935c3320d2ef9e92bdeed05d
# https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1020285
#
# Also check ntp for potential issues with -x or 'slew time', which may not work as expected.
# All NTP 4.2.6 packages (except RedHat's and Oracle's) are currently affected.
# http://bugs.ntp.org/show_bug.cgi?id=2745
#
# -------------------------

kernelVulnerable=0
tzVulnerable=0
ntpAlert=0
strongTZalert=0
potentialTZalert=0

uname_info="$( uname -r )"

echo "Installed kernel version: "$uname_info

# find tzdata version
for tzdata in $( dpkg -s tzdata |grep Version |awk '{print $2}' ); do
	echo "Installed tzdata version: "$tzdata	
		# parse out the year of the installed package release and compare to 2015
		if [ ${tzdata:0:4} -lt 2015 ]; then
			tzVulnerable=1
		fi
done
	
# if tzdata hasn't been patched to 2015, 
# examine the localtime setup to determine level of warning needed
if [ $tzVulnerable -eq '1' ]; then
	localTime_md5=$( md5sum /etc/localtime | awk '{print $1}' )
	for f in $(find '/usr/share/zoneinfo/right' -type f); do
		if [ $strongTZalert -eq '0' ]; then		
		compare_md5=$( md5sum $f | awk '{print $1}' )
			if [[ "$localTime_md5" == "$compare_md5" ]]; then
				strongTZalert=1
			fi
		fi
	done
fi
	
if [ $tzVulnerable -eq '1' ] && [ $strongTZalert -eq '0' ]; then
	potentialTZalert=1
fi

# if clock slewing usage found, check ntp package version and config and warn if needed
ntpPresent=0
for ntpVersion in $( dpkg -s ntp |grep Version |awk '{print $2}' ); do
	if [ -n "$ntpVersion" ]; then
		ntpPresent=1
		echo "Installed ntp version: "$ntpVersion
	fi
done	

if [ $ntpPresent -eq '1' ]; then
	ntpCheck=0

	for matchingNTPConfig in $( grep '\-x' /etc/ntp.conf ); do
		ntpCheck=1
	done

	for matchingNTPConfig in $( grep '\-x' /etc/default/ntp ); do
		ntpCheck=1
	done

	if [ $( grep -aE 'ntpd.*-x' /proc/[0-9]*/cmdline -q; echo $? ) -eq '0' ]; then
		ntpCheck=1
	fi
	
	for matchingNTPConfig in $( grep 'tinker.*step' /etc/ntp.conf ); do
		ntpCheck=1
	done

	for matchingNTPConfig in $( grep 'tinker.*step' /etc/default/ntp ); do
		ntpCheck=1
	done
	
	if [ $ntpCheck -eq '1' ]; then
		for ntpVersion in $( echo $ntpVersion | egrep '4.2.6'); do
			ntpAlert=1
		done	
	fi
fi

# check for kernel version greater than or equal to 3.4
uname_maj=$( echo "$uname_info" | awk -F- '{ print $1 }')

IFS=. major=($uname_maj)
	
if [ "${major[0]}" -eq '3' ]; then
	if [ "${major[1]}" -ge '4' ]; then
		kernelVulnerable=0
	fi
elif [ "${major[0]}" -gt '3' ]; then
	kernelVulnerable=0
else
	kernelVulnerable=1
fi

# print results
if [ $tzVulnerable -eq 0 ] && [ $kernelVulnerable -eq 0 ] && [ $ntpAlert -eq 0 ]; then
	echo "Not vulnerable"
else 
	echo ""
	echo "[SUGGESTIONS]"
	if [ $tzVulnerable -ne 0 ]; then
		if [ $strongTZalert -ne 0 ]; then
		echo 'The installed tzdata package needs to be updated before the Leap Second Insertion of June 30, 2015. '
		elif [ $potentialTZalert -ne 0 ]; then
		echo 'The installed tzdata package may need to be updated before the Leap Second Insertion of June 30, 2015. '
		fi
	fi
	if [ $kernelVulnerable -ne 0 ]; then
		echo 'The running kernel is vulnerable to a performance degradation after the Leap Second Insertion of June 30, 2015.'
		echo 'Refer to <http://www.datastax.com/dev/blog/preparing-for-the-leap-second> and 
		<https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1020285> for more information.'
	fi
	if [ $ntpAlert -ne 0 ]; then
	  echo 'The installed ntp version may not work as expected for slewing time across the leap second.'
	  echo 'Please refer to <http://bugs.ntp.org/show_bug.cgi?id=2745> for additional information.'
	fi
fi

exit